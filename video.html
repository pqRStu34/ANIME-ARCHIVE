<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Anime Series Player</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.7/dist/hls.min.js"></script>
  <style>
    body {
      background: #14161a !important;
      color: #fff;
    }

    .card,
    .card-body {
      background: #16181d !important;
      border-color: #23252a !important;
    }

    .fw-semibold {
      color: #00d1b2;
      font-weight: 600;
    }

    .episode-btn.active,
    .switcher-btns .btn.active,
    .btn-info,
    .btn-info:focus {
      background: rgba(0, 209, 178, 0.18) !important;
      color: #00d1b2 !important;
      border-color: #00d1b2 !important;
      box-shadow: 0 0 0 2px #00d1b244;
    }

    .btn-outline-info {
      color: #6678ff !important;
      border-color: #6678ff !important;
      background: transparent !important;
    }

    .btn-outline-info:hover,
    .btn-outline-info:focus {
      background: #6678ff !important;
      color: #fff !important;
      border-color: #6678ff !important;
    }

    .switcher-row {
      display: flex;
      align-items: center;
      gap: 0.7em;
      margin-bottom: 1em;
    }

    .switcher-label {
      min-width: 60px;
      text-align: right;
      font-size: 1.1em;
      display: flex;
      align-items: center;
      gap: 0.3em;
    }

    .switcher-label i {
      color: #ff6685 !important;
    }

    .switcher-btns {
      display: flex;
      align-items: center;
      gap: 0.5em;
    }

    .episode-btn {
      width: 2.5em;
      margin: 0.15em;
      font-weight: bold;
      border-radius: 6px;
    }

    #playlist {
      display: flex;
      flex-wrap: wrap;
      gap: 0.2em;
    }

    #extra-content {
      margin-top: 1.5em;
    }

    #extra-content .btn {
      margin: 0.2em;
    }

    video {
      width: 100%;
      border-radius: 12px;
      background: #14161a;
    }
  </style>
</head>

<body>
  <div class="container mt-5">
    <div class="row justify-content-center">
      <div class="col-12 col-md-10 col-lg-8">
        <div class="card mb-0 border-0 bg-transparent">
          <div class="card-body p-0 bg-transparent">
            <video id="player" controls playsinline crossorigin="anonymous" controlsList="nodownload"></video>
          </div>
        </div>

        <div id="switcher-card" class="card mt-4 mb-4">
          <div class="card-body">
            <div class="mb-3 switcher-row">
              <span class="switcher-label">
                <i class="bi bi-hdd-network-fill"></i>
              </span>
              <div id="server-switcher" class="switcher-btns"></div>
            </div>
            <div class="mb-3 switcher-row">
              <span class="switcher-label">
                <i class="bi bi-translate"></i>
              </span>
              <div id="mode-switcher" class="switcher-btns"></div>
            </div>
            <div class="mb-1 switcher-row">
              <span class="switcher-label">
                <i class="bi bi-film"></i>
              </span>
              <div id="quality-switcher" class="switcher-btns"></div>
            </div>
          </div>
        </div>
        <div class="card mb-3">
          <div class="card-body">
            <div class="fw-semibold mb-2">EPISODES</div>
            <div id="playlist"></div>
          </div>
        </div>
        <div id="extra-content"></div>
      </div>
    </div>
  </div>
  <script>
    let playlistData = null;
    let current = { episode: 0, server: 0, mode: "subs", quality: 0 };
    const EPISODES_PER_PAGE = 100;

    function getSeriesKey() {
      const params = new URLSearchParams(window.location.search);
      return params.get("series");
    }

    function savePlayerState() {
      localStorage.setItem("videoPlayerState", JSON.stringify(current));
    }
    function loadPlayerState() {
      const state = localStorage.getItem("videoPlayerState");
      if (state) {
        try { return JSON.parse(state); } catch { }
      }
      return { episode: 0, server: 0, mode: "subs", quality: 0 };
    }

    async function loadPlaylist() {
      const seriesKey = getSeriesKey();
      if (!seriesKey) return;
      try {
        const res = await fetch(seriesKey + ".json");
        playlistData = await res.json();
        if (Array.isArray(playlistData.video)) {
          renderMoviePlayer();
        } else {
          renderServerSwitcher();
          renderModeSwitcher();
          renderQualitySwitcher();
          renderEpisodes();
          renderExtraContent();
          playEpisode(current.episode, current.server, current.mode, current.quality);
        }
      } catch (e) {
        document.getElementById("playlist").innerHTML = '<span class="text-danger">Failed to load playlist.</span>';
      }
    }


    function renderServerSwitcher() {
      const ep = (playlistData.episodes || [])[current.episode];
      if (!ep) return;
      const div = document.getElementById("server-switcher");
      div.innerHTML = "";
      (ep.servers || []).forEach((srv, i) => {
        const btn = document.createElement("button");
        btn.className = "btn btn-sm btn-outline-info";
        if (i === current.server) btn.classList.add("active");
        btn.textContent = srv.name || `Server ${i + 1}`;
        btn.onclick = () => { current.server = i; current.quality = 0; renderServerSwitcher(); renderModeSwitcher(); renderQualitySwitcher(); playEpisode(current.episode, i, current.mode, 0); };
        div.appendChild(btn);
      });
    }

    function renderModeSwitcher() {
      const ep = (playlistData.episodes || [])[current.episode];
      if (!ep) return;
      const server = ep.servers[current.server];
      const div = document.getElementById("mode-switcher");
      div.innerHTML = "";
      ["subs", "dubs"].forEach(mode => {
        if (server[mode] && server[mode].length > 0) {
          const btn = document.createElement("button");
          btn.className = "btn btn-sm btn-subdub btn-outline-info";
          if (current.mode === mode) btn.classList.add("active");
          btn.textContent = mode.toUpperCase();
          btn.onclick = () => { current.mode = mode; current.quality = 0; renderModeSwitcher(); renderQualitySwitcher(); playEpisode(current.episode, current.server, mode, 0); };
          div.appendChild(btn);
        }
      });
    }

    function renderQualitySwitcher() {
      const ep = (playlistData.episodes || [])[current.episode];
      if (!ep) return;
      const server = ep.servers[current.server];
      const qualities = server[current.mode] || [];
      const div = document.getElementById("quality-switcher");
      div.innerHTML = "";
      ["480p", "720p", "1080p"].forEach(q => {
        const idx = qualities.findIndex(s => s.quality === q);
        if (idx !== -1) {
          const btn = document.createElement("button");
          btn.className = "btn btn-sm btn-outline-info";
          if (current.quality === idx) btn.classList.add("active");
          btn.textContent = q;
          btn.onclick = () => { current.quality = idx; renderQualitySwitcher(); playEpisode(current.episode, current.server, current.mode, idx); };
          div.appendChild(btn);
        }
      });
    }

    function renderEpisodes() {
      const playlist = document.getElementById("playlist");
      playlist.innerHTML = "";
      const episodes = playlistData.episodes || [];
      episodes.forEach((ep, i) => {
        const btn = document.createElement("button");
        btn.className = "btn btn-outline-info btn-sm episode-btn";
        if (i === current.episode) btn.classList.add("active");
        btn.textContent = (i + 1).toString();
        btn.onclick = () => { current.episode = i; current.server = 0; current.mode = "subs"; current.quality = 0; renderServerSwitcher(); renderModeSwitcher(); renderQualitySwitcher(); renderEpisodes(); playEpisode(i, 0, "subs", 0); };
        playlist.appendChild(btn);
      });
    }

    function playEpisode(episodeIdx, serverIdx, mode, qualityIdx) {
      savePlayerState();
      const ep = (playlistData.episodes || [])[episodeIdx];
      if (!ep) return;
      const server = ep.servers[serverIdx];
      const sources = server[mode] || [];
      const source = sources[qualityIdx];
      const video = document.getElementById("player");
      // Remove all tracks
      while (video.firstChild) video.removeChild(video.firstChild);
      // Add subtitles (track)
      let enTrack = null;
      if (ep.subtitles && Array.isArray(ep.subtitles)) {
        ep.subtitles.forEach(sub => {
          if (sub.src) {
            const track = document.createElement("track");
            track.kind = "subtitles";
            track.label = sub.label || sub.lang || "Subtitles";
            track.srclang = sub.lang || "en";
            track.src = sub.src;
            track.default = true;
            video.appendChild(track);
            if ((sub.lang || "en").toLowerCase() === "en") enTrack = track;
          }
        });
      }
      // Set video source
      if (source) {
        if (source.type === "application/x-mpegURL") {
          if (window.Hls && Hls.isSupported()) {
            if (window.hlsInstance) { window.hlsInstance.destroy(); }
            window.hlsInstance = new Hls();
            window.hlsInstance.loadSource(source.src);
            window.hlsInstance.attachMedia(video);
            window.hlsInstance.on(Hls.Events.MANIFEST_PARSED, function () { video.play(); });
            video.onended = () => playNextEpisode();
          } else if (video.canPlayType("application/vnd.apple.mpegurl")) {
            video.src = source.src;
            video.addEventListener("loadedmetadata", function () { video.play(); });
            video.onended = () => playNextEpisode();
          }
        } else {
          video.src = source.src;
          video.type = source.type;
          video.load();
          video.play();
          video.onended = () => playNextEpisode();
        }
      }

    }

    function playNextEpisode() {
      const episodes = playlistData.episodes || [];
      if (current.episode + 1 < episodes.length) {
        current.episode++;
        current.server = 0;
        current.mode = "subs";
        current.quality = 0;
        renderServerSwitcher();
        renderModeSwitcher();
        renderQualitySwitcher();
        renderEpisodes();
        playEpisode(current.episode, 0, "subs", 0);
      }
    }

    function renderMoviePlayer() {
      document.getElementById("switcher-card").style.display = "none";
      document.getElementById("playlist").innerHTML = "<span class='text-secondary'>This is a movie.</span>";
      const video = document.getElementById("player");
      // Find best quality source
      let best = null;
      (playlistData.video || []).forEach(srv => {
        if (Array.isArray(srv.sources)) {
          const found = srv.sources.find(q => q.quality === "1080p") || srv.sources.find(q => q.quality === "720p") || srv.sources[0];
          if (found && !best) best = found;
        }
      });
      if (best) {
        if (best.type === "application/x-mpegURL" && window.Hls && Hls.isSupported()) {
          if (window.hlsInstance) { window.hlsInstance.destroy(); }
          window.hlsInstance = new Hls();
          window.hlsInstance.loadSource(best.src);
          window.hlsInstance.attachMedia(video);
          window.hlsInstance.on(Hls.Events.MANIFEST_PARSED, function () { video.play(); });
        } else {
          window.addEventListener("DOMContentLoaded", () => {
            current = loadPlayerState();
            loadPlaylist();
          });
        }
      }
    }

    function renderExtraContent() {
      const div = document.getElementById("extra-content");
      div.innerHTML = "";
      const extra = playlistData.extra || [];
      if (extra.length === 0) return;
      const title = document.createElement("div");
      title.className = "fw-semibold mb-2";
      title.textContent = "EXTRA CONTENT";
      div.appendChild(title);
      extra.forEach((item, idx) => {
        const btn = document.createElement("button");
        btn.className = "btn btn-outline-info btn-sm";
        btn.textContent = item.title || item.type || `Extra ${idx + 1}`;
        btn.onclick = () => playExtra(idx);
        div.appendChild(btn);
      });
    }

    function playExtra(idx) {
      const extra = playlistData.extra || [];
      const item = extra[idx];
      if (!item) return;
      const video = document.getElementById("player");
      while (video.firstChild) video.removeChild(video.firstChild);
      if (item.type === "application/x-mpegURL" && window.Hls && Hls.isSupported()) {
        if (window.hlsInstance) { window.hlsInstance.destroy(); }
        window.hlsInstance = new Hls();
        window.hlsInstance.loadSource(item.src);
        window.hlsInstance.attachMedia(video);
        window.hlsInstance.on(Hls.Events.MANIFEST_PARSED, function () { video.play(); });
      } else {
        video.src = item.src;
        video.type = item.type;
        video.load();
        video.play();
      }
    }

    window.addEventListener("DOMContentLoaded", () => {
      current = loadPlayerState();
      loadPlaylist();
    });
  </script>
</body>

</html>