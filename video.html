<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Anime Archive - Video Player</title>
    <!-- Bootstrap 5 CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css"
      rel="stylesheet"
      crossorigin="anonymous"
    />
    <!-- Bootstrap Icons -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css"
    />
    <!-- Video.js CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/video.js@8.10.0/dist/video-js.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/videojs-ima@1.10.1/dist/videojs.ima.min.css"
      rel="stylesheet"
    />
    <style>
      .video-js {
        border-radius: 12px;
        width: 100%;
        background: #000;
      }

      .vjs-control:focus {
        outline: 2px solid #0dcaf0;
      }

      .switcher-row {
        display: flex;
        align-items: center;
        gap: 0.7em;
        margin-bottom: 1em;
      }

      .switcher-label {
        min-width: 60px;
        text-align: right;
        font-size: 1.1em;
        display: flex;
        align-items: center;
        gap: 0.3em;
      }

      .switcher-btns {
        display: flex;
        align-items: center;
        gap: 0.5em;
      }

      .hamburger-card {
        position: relative;
      }

      .hamburger-menu {
        position: absolute;
        left: 0;
        right: 0;
        background: #fff;
        box-shadow: 0 4px 24px #b5b5b5;
        border-radius: 0 0 8px 8px;
        z-index: 10;
        padding: 0.5em 0.5em 0.7em 0.5em;
        animation: fadeIn 0.2s;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }

        to {
          opacity: 1;
          transform: none;
        }
      }

      .adv-search-toggle {
        display: flex;
        align-items: center;
        cursor: pointer;
        user-select: none;
        font-size: 1.2em;
        font-weight: 700;
        color: #0dcaf0;
        margin-bottom: 1rem;
        transition: color 0.2s;
      }

      .adv-search-toggle .hamburger {
        width: 24px;
        height: 24px;
        position: relative;
        display: inline-block;
        margin-right: 0.7em;
      }

      .adv-search-toggle .bar {
        display: block;
        position: absolute;
        height: 3px;
        width: 100%;
        background: #0dcaf0;
        border-radius: 2px;
        opacity: 1;
        left: 0;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .adv-search-toggle .bar1 {
        top: 4px;
      }

      .adv-search-toggle .bar2 {
        top: 10px;
      }

      .adv-search-toggle .bar3 {
        top: 16px;
      }

      .adv-search-toggle.open .bar1 {
        transform: rotate(45deg);
        top: 10px;
      }

      .adv-search-toggle.open .bar2 {
        opacity: 0;
      }

      .adv-search-toggle.open .bar3 {
        transform: rotate(-45deg);
        top: 10px;
      }
    </style>
  </head>

  <body>
    <div class="container mt-5">
      <div class="row justify-content-center">
        <div class="col-12 col-md-10 col-lg-8">
          <div class="card mb-0 border-0 bg-transparent">
            <div class="card-body p-0 bg-transparent">
              <!-- Video.js Player -->
              <video
                id="player"
                class="video-js vjs-big-play-centered"
                controls
                preload="auto"
                crossorigin="anonymous"
                playsinline
                width="100%"
                height="100%"
              ></video>
            </div>
          </div>
          <!-- Server Switcher Card -->
          <div id="switcher-card" class="card mt-4 mb-4">
            <div class="card-body">
              <div class="mb-3 switcher-row">
                <span class="switcher-label">
                  <i class="bi bi-hdd-network-fill"></i>
                </span>
                <div id="server-switcher" class="switcher-btns"></div>
              </div>
              <div class="mb-3 switcher-row">
                <span class="switcher-label">
                  <i class="bi bi-file-earmark-music-fill"></i>
                </span>
                <div id="mode-switcher" class="switcher-btns"></div>
              </div>
              <div class="mb-1 switcher-row">
                <span class="switcher-label">
                  <i class="bi bi-film"></i>
                </span>
                <div id="quality-switcher" class="switcher-btns"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- Playlist Section (Episodes, paginated, NOT hamburger) -->
      <div class="row justify-content-center">
        <div class="col-12 col-md-10 col-lg-8">
          <div class="card">
            <div class="card-body" style="padding: 0.5em 1em">
              <div class="mb-2 fw-semibold">EPISODES</div>
              <div id="playlist" class="list-group"></div>
              <nav
                class="d-flex justify-content-center mt-3"
                aria-label="pagination"
              >
                <button
                  class="btn btn-outline-secondary btn-sm me-2"
                  id="episodes-prev"
                  title="Previous"
                >
                  <i class="bi bi-chevron-left"></i>
                </button>
                <ul class="pagination mb-0" id="episodes-pagination"></ul>
                <button
                  class="btn btn-outline-secondary btn-sm ms-2"
                  id="episodes-next"
                  title="Next"
                >
                  <i class="bi bi-chevron-right"></i>
                </button>
              </nav>
            </div>
          </div>
        </div>
      </div>
      <!-- Extra Content Section (OVA, Movies, etc.) as Hamburger/Collapsible -->
      <div
        class="row justify-content-center"
        id="extra-content-row"
        style="display: none"
      >
        <div class="col-12 col-md-10 col-lg-8">
          <div class="card">
            <div class="card-body" style="padding: 0.5em 1em">
              <div id="extra-content-hamburger" class="hamburger-card">
                <div
                  id="extra-content-hamburger-toggle"
                  class="adv-search-toggle"
                  style="margin-bottom: 0"
                >
                  <span class="hamburger">
                    <span class="bar bar1"></span>
                    <span class="bar bar2"></span>
                    <span class="bar bar3"></span>
                  </span>
                  <span class="fw-semibold"
                    ><i class="bi bi-film"></i> Extra Content (OVA, Movies,
                    Specials)</span
                  >
                </div>
                <div
                  id="extra-content-hamburger-menu"
                  class="hamburger-menu"
                  style="display: none"
                >
                  <div
                    id="extra-content-buttons"
                    class="d-flex justify-content-center flex-wrap gap-2"
                  ></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Bootstrap JS -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"
      crossorigin="anonymous"
    ></script>
    <!-- Video.js -->
    <script src="https://cdn.jsdelivr.net/npm/video.js@8.10.0/dist/video.min.js"></script>
    <!-- Video.js HLS (videojs-http-streaming is built-in for v8+) -->
    <!-- Video.js IMA Ads -->
    <script src="https://cdn.jsdelivr.net/npm/videojs-ima@1.10.1/dist/videojs.ima.min.js"></script>
    <script>
      const adTagUrl =
        "https://pubads.g.doubleclick.net/gampad/ads?sz=640x480&iu=/124319096/external/single_ad_samples&ciu_szs=300x250&impl=s&gdfp_req=1&env=vp&output=vast&unviewed_position_start=1&cust_params=deployment%3Ddevsite%26sample_ct%3Dlinear&correlator=";

      let playlistData = [];
      let videojsPlayer;
      let current = { episode: 0, server: 0, mode: "subs", quality: 0 };
      let episodesPage = 1;
      const EPISODES_PER_PAGE = 12;

      // --- Persist current state in localStorage ---
      function savePlayerState() {
        localStorage.setItem("videoPlayerState", JSON.stringify(current));
      }
      function loadPlayerState() {
        const state = localStorage.getItem("videoPlayerState");
        if (state) {
          try {
            return JSON.parse(state);
          } catch (e) {}
        }
        return { episode: 0, server: 0, mode: "subs", quality: 0 };
      }

      // Get series key from URL
      function getSeriesKey() {
        const params = new URLSearchParams(window.location.search);
        return params.get("series") || "series-json/series1";
      }

      // Fetch playlist from JSON file
      async function loadPlaylist() {
        try {
          const seriesKey = getSeriesKey();
          const res = await fetch(seriesKey + ".json");
          playlistData = await res.json();
          episodesPage = 1;
          renderPlaylist();
          playEpisode(0, 0, "subs", 0);
          renderExtraContent();
        } catch (e) {
          document.getElementById("playlist").innerHTML =
            '<p class="text-danger">Failed to load playlist.</p>';
        }
      }

      // Render playlist
      function renderPlaylist() {
        const playlist = document.getElementById("playlist");
        playlist.innerHTML = "";
        const episodes = playlistData.episodes || [];
        const start = (episodesPage - 1) * EPISODES_PER_PAGE;
        const end = start + EPISODES_PER_PAGE;
        const pageEpisodes = episodes.slice(start, end);
        pageEpisodes.forEach((ep, idx) => {
          const a = document.createElement("button");
          a.type = "button";
          a.className =
            "list-group-item list-group-item-action" +
            (start + idx === current.episode ? " active" : "");
          a.textContent = ep.title;
          a.onclick = () => {
            playEpisode(start + idx, 0, "subs", 0);
          };
          playlist.appendChild(a);
        });
        renderEpisodesPagination();
      }

      // Render episodes pagination
      function renderEpisodesPagination() {
        const episodes = playlistData.episodes || [];
        const totalPages = Math.ceil(episodes.length / EPISODES_PER_PAGE);
        const prev = document.getElementById("episodes-prev");
        const next = document.getElementById("episodes-next");
        const pagelist = document.getElementById("episodes-pagination");
        prev.disabled = episodesPage === 1;
        next.disabled = episodesPage === totalPages;
        prev.onclick = () => {
          if (episodesPage > 1) {
            episodesPage--;
            renderPlaylist();
          }
        };
        next.onclick = () => {
          if (episodesPage < totalPages) {
            episodesPage++;
            renderPlaylist();
          }
        };
        pagelist.innerHTML = "";
        for (let i = 1; i <= totalPages; i++) {
          const li = document.createElement("li");
          li.className = "page-item" + (i === episodesPage ? " active" : "");
          const a = document.createElement("button");
          a.className = "page-link";
          a.textContent = i;
          a.onclick = () => {
            episodesPage = i;
            renderPlaylist();
          };
          li.appendChild(a);
          pagelist.appendChild(li);
        }
      }

      // Highlight active episode
      function highlightActiveEpisode() {
        document
          .querySelectorAll("#playlist .list-group-item")
          .forEach((a, idx) => {
            if (idx === current.episode % EPISODES_PER_PAGE)
              a.classList.add("active");
            else a.classList.remove("active");
          });
      }

      // Render switchers
      function renderSwitchers() {
        const ep = (playlistData.episodes || [])[current.episode];
        if (!ep) return;
        // Server Switcher
        const serverDiv = document.getElementById("server-switcher");
        serverDiv.innerHTML = "";
        ep.servers.forEach((srv, i) => {
          const btn = document.createElement("button");
          btn.className =
            "btn btn-sm" +
            (i === current.server
              ? " btn-info text-white"
              : " btn-outline-info");
          btn.textContent = srv.name;
          btn.onclick = () => playEpisode(current.episode, i, current.mode, 0);
          serverDiv.appendChild(btn);
        });
        // Mode Switcher (SUB/DUB)
        const modeDiv = document.getElementById("mode-switcher");
        modeDiv.innerHTML = "";
        const hasSubs =
          ep.servers[current.server].subs &&
          ep.servers[current.server].subs.length > 0;
        const hasDubs =
          ep.servers[current.server].dubs &&
          ep.servers[current.server].dubs.length > 0;
        // SUB button
        const subBtn = document.createElement("button");
        subBtn.className =
          "btn btn-success btn-sm" +
          (current.mode === "subs" ? " active" : "") +
          (hasSubs ? "" : " disabled");
        subBtn.textContent = "SUB";
        subBtn.disabled = !hasSubs;
        subBtn.onclick = () =>
          hasSubs && playEpisode(current.episode, current.server, "subs", 0);
        modeDiv.appendChild(subBtn);
        // DUB button
        const dubBtn = document.createElement("button");
        dubBtn.className =
          "btn btn-success btn-sm" +
          (current.mode === "dubs" ? " active" : "") +
          (hasDubs ? "" : " disabled");
        dubBtn.textContent = "DUB";
        dubBtn.disabled = !hasDubs;
        dubBtn.onclick = () =>
          hasDubs && playEpisode(current.episode, current.server, "dubs", 0);
        modeDiv.appendChild(dubBtn);
        // Quality Switcher
        const qualityDiv = document.getElementById("quality-switcher");
        qualityDiv.innerHTML = "";
        const qualities = ep.servers[current.server][current.mode] || [];
        qualities.forEach((q, i) => {
          const btn = document.createElement("button");
          btn.className =
            "btn btn-sm" +
            (i === current.quality
              ? " btn-info text-white"
              : " btn-outline-info");
          btn.textContent = q.quality || `Q${i + 1}`;
          btn.onclick = () =>
            playEpisode(current.episode, current.server, current.mode, i);
          qualityDiv.appendChild(btn);
        });
      }

      // Play episode
      function playEpisode(
        episodeIdx = 0,
        serverIdx = 0,
        mode = "subs",
        qualityIdx = 0
      ) {
        current = {
          episode: episodeIdx,
          server: serverIdx,
          mode,
          quality: qualityIdx,
        };
        savePlayerState();
        highlightActiveEpisode();
        renderSwitchers();
        const ep = (playlistData.episodes || [])[episodeIdx];
        if (!ep) return;
        const server = ep.servers[serverIdx];
        const sources = server[mode] || [];
        const source = sources[qualityIdx];
        const video = document.getElementById("player");

        // Dispose previous player if exists
        if (videojsPlayer) {
          videojsPlayer.ima &&
            videojsPlayer.ima.reset &&
            videojsPlayer.ima.reset();
          videojsPlayer.dispose();
        }

        // Prepare sources for video.js
        let videoSources = [];
        if (source) {
          videoSources.push({
            src: source.src,
            type: source.type,
          });
        }

        // Init video.js
        videojsPlayer = videojs(video, {
          controls: true,
          autoplay: false,
          preload: "auto",
          sources: videoSources,
          fluid: true,
        });

        // IMA Ads plugin
        videojsPlayer.ima({
          id: "player",
          adTagUrl: adTagUrl,
          debug: false,
        });

        // Play ad
      }
      // Load state and playlist on page load
      window.addEventListener("DOMContentLoaded", () => {
        current = loadPlayerState();
        loadPlaylist();
      });

      // Hamburger for extra content
      function renderExtraContent() {
        const extra = playlistData.extra || [];
        const row = document.getElementById("extra-content-row");
        if (extra.length === 0) {
          row.style.display = "none";
          return;
        }
        row.style.display = "";
        const btnsDiv = document.getElementById("extra-content-buttons");
        btnsDiv.innerHTML = "";
        extra.forEach((item, idx) => {
          const btn = document.createElement("button");
          btn.className = "btn btn-outline-info btn-sm";
          btn.textContent = item.title;
          btn.onclick = () => {
            // Play extra content (assume same structure as episodes)
            playExtraContent(idx);
          };
          btnsDiv.appendChild(btn);
        });
      }

      function playExtraContent(idx) {
        const extra = playlistData.extra || [];
        const item = extra[idx];
        if (!item) return;
        // For simplicity, use first server, subs, first quality
        playEpisode(0, 0, "subs", 0);
        // Replace video source with extra content
        if (videojsPlayer) {
          videojsPlayer.src({
            src: item.src,
            type: item.type,
          });
          videojsPlayer.play();
        }
      }

      // Hamburger toggle logic
      const hamburgerToggle = document.getElementById(
        "extra-content-hamburger-toggle"
      );
      const hamburgerMenu = document.getElementById(
        "extra-content-hamburger-menu"
      );
      hamburgerToggle &&
        hamburgerToggle.addEventListener("click", function () {
          this.classList.toggle("open");
          if (hamburgerMenu.style.display === "none") {
            hamburgerMenu.style.display = "";
          } else {
            hamburgerMenu.style.display = "none";
          }
        });
    </script>
  </body>
</html>
