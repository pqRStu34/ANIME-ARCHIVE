<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Anime Archive - Movie Player</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet"
        crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css" />
    <style>
        .switcher-label i {
            color: #ff6685 !important;
        }

        .switcher-btns .btn.active {
            background: rgba(0, 209, 178, 0.18) !important;
            color: #00d1b2 !important;
            border-color: #00d1b2 !important;
            box-shadow: 0 0 0 2px #00d1b244;
        }

        body {
            background: #14161a !important;
        }

        .card,
        .card-body {
            background: #16181d !important;
            border-color: #23252a !important;
        }

        .movie-info-card img {
            width: 110px;
            height: 160px;
            object-fit: cover;
            border-radius: 10px;
        }

        .movie-info-card .title {
            font-size: 1.5em;
            font-weight: 600;
            color: #fff;
        }

        .movie-info-card .meta {
            color: #00d1b2;
            font-size: 1.05em;
            margin-bottom: 0.5em;
        }

        .movie-info-card .desc {
            color: #ccc;
            font-size: 1em;
            margin-bottom: 1em;
        }

        .btn-info,
        .btn-outline-info,
        .btn-info.text-white {
            background-color: #6678ff !important;
            border-color: #6678ff !important;
            color: #fff !important;
        }

        .btn-outline-info {
            background: transparent !important;
            color: #6678ff !important;
        }

        .btn-outline-info:hover,
        .btn-outline-info:focus {
            background: #6678ff !important;
            color: #fff !important;
            border-color: #6678ff !important;
        }

        .movie-player {
            border-radius: 12px;
            width: 100%;
            background: #14161a;
            margin-bottom: 1.5em;
        }

        .switcher-row {
            display: flex;
            align-items: center;
            gap: 0.7em;
            margin-bottom: 1em;
        }

        .switcher-label {
            min-width: 60px;
            text-align: right;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            gap: 0.3em;
        }

        .switcher-btns {
            display: flex;
            align-items: center;
            gap: 0.5em;
        }
    </style>
</head>

<body>
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-12 col-md-10 col-lg-8">
                <div class="card mb-0 border-0 bg-transparent">
                    <div class="card-body p-0 bg-transparent">
                        <video id="player" class="movie-player" controls crossorigin="anonymous" playsinline
                            width="100%" height="100%" style="border-radius: 12px; background: #14161a; width: 100%"
                            controlsList="nodownload" oncontextmenu="return false;"></video>
                    </div>
                </div>
                <!-- Server/Mode/Quality Switchers -->
                <div id="switcher-card" class="card mt-4 mb-4">
                    <div class="card-body">
                        <div class="mb-3 switcher-row">
                            <span class="switcher-label">
                                <i class="bi bi-hdd-network-fill"></i>
                            </span>
                            <div id="server-switcher" class="switcher-btns"></div>
                        </div>
                        <div class="mb-3 switcher-row">
                            <span class="switcher-label">
                                <i class="bi bi-translate"></i>
                            </span>
                            <div id="mode-switcher" class="switcher-btns"></div>
                        </div>
                        <div class="mb-1 switcher-row">
                            <span class="switcher-label">
                                <i class="bi bi-film"></i>
                            </span>
                            <div id="quality-switcher" class="switcher-btns"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        // Prevent long-press download on video (mobile and desktop)
        const preventVideoLongPress = () => {
            const video = document.getElementById('player');
            if (!video) return;
            // Prevent context menu
            video.addEventListener('contextmenu', e => e.preventDefault());
            // Prevent long-press on mobile
            let pressTimer = null;
            video.addEventListener('touchstart', function (e) {
                pressTimer = setTimeout(() => {
                    e.preventDefault();
                }, 400);
            }, { passive: false });
            video.addEventListener('touchend', function () {
                clearTimeout(pressTimer);
            });
        };
        window.addEventListener('DOMContentLoaded', preventVideoLongPress);
        // Get movie key from URL
        function getMovieKey() {
            const params = new URLSearchParams(window.location.search);
            return params.get("movie");
        }
        // Fetch movie JSON and render
        async function loadMovie() {
            try {
                const movieKey = getMovieKey();
                if (!movieKey) {
                    document.getElementById("movie-info").innerHTML = '<div class="p-3 text-danger">No movie selected.</div>';
                    document.getElementById("movie-info").style.display = '';
                    return;
                }
                const res = await fetch(movieKey + ".json");
                const movie = await res.json();
                setupPlayer(movie);
            } catch (e) {
                document.getElementById("movie-info").innerHTML = '<div class="p-3 text-danger">Failed to load movie.</div>';
                document.getElementById("movie-info").style.display = '';
            }
        }
        // Render movie info card

        // Setup player with best quality and populate switchers
        // Track current selection
        let currentSelection = { server: 0, mode: null, quality: null };
        function setupPlayer(movie) {
            setupServerAndQualitySwitchers(movie);
            playMovie(movie);
        }

        // Populate server and quality switchers
        function setupServerAndQualitySwitchers(movie) {
            const servers = Array.isArray(movie.video) ? movie.video : [];
            const serverSwitcher = document.getElementById("server-switcher");
            const qualitySwitcher = document.getElementById("quality-switcher");
            const modeSwitcher = document.getElementById("mode-switcher");
            serverSwitcher.innerHTML = '';
            qualitySwitcher.innerHTML = '';
            if (modeSwitcher) modeSwitcher.innerHTML = '';
            if (servers.length === 0) return;

            // Find all available modes (sub/dub) across all servers
            let allModes = new Set();
            servers.forEach(server => {
                if (Array.isArray(server.sources)) {
                    server.sources.forEach(src => {
                        if (src.mode) allModes.add(src.mode);
                    });
                }
            });
            allModes = Array.from(allModes);

            // Server buttons
            servers.forEach((server, sIdx) => {
                const btn = document.createElement("button");
                btn.className = "btn btn-outline-info btn-sm";
                btn.textContent = server.name || `Server ${sIdx + 1}`;
                if (currentSelection.server === sIdx) btn.classList.add('active');
                btn.onclick = () => {
                    currentSelection.server = sIdx;
                    playMovie(movie, sIdx, null, currentSelection.mode, currentSelection.quality);
                    setupServerAndQualitySwitchers(movie);
                };
                serverSwitcher.appendChild(btn);
            });

            // Mode buttons (sub/dub)
            if (modeSwitcher && allModes.length > 0) {
                allModes.forEach((mode, mIdx) => {
                    const btn = document.createElement("button");
                    btn.className = "btn btn-outline-info btn-sm";
                    btn.textContent = mode.charAt(0).toUpperCase() + mode.slice(1);
                    if (currentSelection.mode === mode) btn.classList.add('active');
                    btn.onclick = () => {
                        currentSelection.mode = mode;
                        playMovie(movie, currentSelection.server, null, mode, currentSelection.quality);
                        setupServerAndQualitySwitchers(movie);
                    };
                    modeSwitcher.appendChild(btn);
                });
            }

            // Quality buttons (show all unique qualities across all servers)
            let allQualities = [];
            servers.forEach(server => {
                if (Array.isArray(server.sources)) {
                    server.sources.forEach(src => {
                        if (src.quality && !allQualities.includes(src.quality)) allQualities.push(src.quality);
                    });
                }
            });
            allQualities.forEach((quality) => {
                const btn = document.createElement("button");
                btn.className = "btn btn-outline-info btn-sm";
                btn.textContent = quality;
                if (currentSelection.quality === quality) btn.classList.add('active');
                btn.onclick = () => {
                    currentSelection.quality = quality;
                    playMovie(movie, currentSelection.server, null, currentSelection.mode, quality);
                    setupServerAndQualitySwitchers(movie);
                };
                qualitySwitcher.appendChild(btn);
            });
        }

        // Play best quality or selected server/mode/quality
        function playMovie(movie, serverIdx = 0, qualityIdx = null, mode = null, quality = null) {
            const video = document.getElementById("player");
            if (!video) return;
            while (video.firstChild) video.removeChild(video.firstChild);
            // Add captions/subtitles tracks if present
            if (Array.isArray(movie.tracks)) {
                movie.tracks.forEach(track => {
                    const trackEl = document.createElement('track');
                    trackEl.kind = track.kind || 'subtitles';
                    trackEl.label = track.label || '';
                    trackEl.srclang = track.srclang || '';
                    trackEl.src = track.src;
                    if (track.default) trackEl.default = true;
                    video.appendChild(trackEl);
                });
            }
            const servers = Array.isArray(movie.video) ? movie.video : [];
            let source = null;
            if (servers.length > 0) {
                const server = servers[serverIdx] || servers[0];
                if (Array.isArray(server.sources)) {
                    let filtered = server.sources;
                    if (mode) filtered = filtered.filter(s => s.mode === mode);
                    if (quality) filtered = filtered.filter(s => s.quality === quality);
                    if (qualityIdx !== null && filtered[qualityIdx]) {
                        source = filtered[qualityIdx];
                    } else {
                        // Prefer 4k, then 1080p, 720p, 480p, then first
                        source = filtered.find(s => s.quality === "4k") ||
                            filtered.find(s => s.quality === "1080p") ||
                            filtered.find(s => s.quality === "720p") ||
                            filtered.find(s => s.quality === "480p") ||
                            filtered[0];
                    }
                }
            }
            // Update currentSelection to reflect the actual source used
            currentSelection.server = serverIdx;
            currentSelection.mode = mode || (source && source.mode) || null;
            currentSelection.quality = quality || (source && source.quality) || null;
            if (source) {
                video.src = source.src;
                video.type = source.type;
                video.load();
                video.play();
            } else {
                video.removeAttribute("src");
                video.load();
            }
        }
        window.addEventListener("DOMContentLoaded", loadMovie);
    </script>
</body>

</html>